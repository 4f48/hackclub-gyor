---
import { DISCORD_CLIENT_ID, DISCORD_CLIENT_SECRET } from "astro:env/server";
import Layout from "@/layouts/html.astro";
import { db } from "@/lib/db";
import { member } from "@/lib/schema";
import { eq } from "drizzle-orm";
import { DISCORD_BOT_TOKEN } from "astro:env/server";

try {
    const code = Astro.url.searchParams.get("code");
    const state = Astro.url.searchParams.get("state");
    if (!code || !state)
        return new Response("no oauth code and/or state provided", {
            status: 400,
        });

    const payload = {
        client_id: DISCORD_CLIENT_ID,
        client_secret: DISCORD_CLIENT_SECRET,
        grant_type: "authorization_code",
        code,
        redirect_uri: "https://hackclubgyor.com/discord/callback",
    };
    const response = await fetch("https://discord.com/api/oauth2/token", {
        method: "post",
        headers: {
            "content-type": "application/x-www-form-urlencoded",
        },
        body: new URLSearchParams(payload).toString(),
    });
    const results: {
        access_token: string;
    } = await response.json();
    const access_token = results.access_token;

    const user: {
        id: string;
    } = await (
        await fetch("https://discord.com/api/users/@me", {
            headers: {
                authorization: `Bearer ${access_token}`,
                "content-type": "application/x-www-form-urlencoded",
            },
        })
    ).json();

    const { rowsAffected } = await db
        .update(member)
        .set({
            discord: user.id,
        })
        .where(eq(member.id, state));
    if (rowsAffected !== 1)
        return new Response("user not found", { status: 404 });

    await fetch(
        `https://discord.com/api/guilds/1397533229229019267/members/${user.id}`,
        {
            body: JSON.stringify({ access_token }),
            headers: {
                "content-type": "application/json",
                authorization: `Bot ${DISCORD_BOT_TOKEN}`,
            },
            method: "put",
        },
    );
} catch (err) {
    console.error(err);
    return new Response("something went wronk", { status: 500 });
}
---

<Layout class="flex justify-center">
    <main class="md:mt-24 p-6 text-justify md:w-xl">
        <h1 class="text-2xl font-extrabold text-[#00ff00]">Hurrá!</h1>
        <p>
            Kész is vagy. A Hack Club Győr teljes körű tagja lettél. Hozzáadtunk
            a Discord szerverünkhöz ahol értesülhetsz a találkozókról és egyéb
            workshopokról.
        </p>
    </main>
</Layout>
